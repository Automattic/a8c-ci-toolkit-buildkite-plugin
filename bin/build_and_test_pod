#!/bin/bash -eu

# Allow the fastlane lane name to be passed as the first argument, but default to `test`
LANE_NAME="${1:-test}"

echo "--- :rubygems: Setting up Gems"
install_gems

if [ -f "Podfile.lock" ]; then
	echo "--- :cocoapods: Setting up Pods"
	install_cocoapods
fi

if [ -f "Example/Podfile.lock" ]; then
	cd Example
	echo "--- :cocoapods: Setting up Pods"
	install_cocoapods
	cd -
fi

echo "--- :test_tube: Building and Running Tests"

# For some reason this fixes a failure in `lib lint`
# https://github.com/Automattic/buildkite-ci/issues/7
xcrun simctl list >> /dev/null

# FIXME: Missing quotation of $LANE_NAME
#
# The fact that $LANE_NAME is not quoted here means that if we pass something
# like a quoted 'foo bar' as the sole parameter of this script, this will in
# fact end up calling 'fastlane foo bar' (with 2 parameters to fastlane)
#
# We should instead use something like "$@" â€“ which expands to each paramater passed
# to the script, automatically individually quoted. This would be a breaking change
# though, so should only be done when we're ready to do a major version bump and
# update all call sites relying on this.
bundle exec fastlane $LANE_NAME
