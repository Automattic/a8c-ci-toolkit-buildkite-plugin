#!/usr/bin/env ruby
# shellcheck disable=all

#
# Usage:
#   annotate-test-failures [junit-file-path]
#
require 'rexml/document'

junit_path = ARGV.first || File.join('build/results/report.junit')
title = ENV.fetch('BUILDKITE_LABEL', 'Tests')

file = File.open(junit_path)
xmldoc = REXML::Document.new(file)

failures = []
REXML::XPath.each(xmldoc, '//testcase[failure]') do |testcase|
    failure = testcase.elements['failure']
    failures.append <<~ENTRY
    <details><summary><tt>#{testcase['name']}</tt> in <tt>#{testcase['classname']}</tt></summary>
    
    #{failure['message']}

    ```
    #{failure.text}
    ```
    </details>
    ENTRY
end

markdown = "\#\#\#\# #{title}: #{failures.length} failure(s)\n\n" + failures.join("\n")
system('buildkite-agent', 'annotate', '--style', 'error', '--context', title)
