#!/bin/bash -eu

AWS_BUCKET=${1:-$GIT_MIRROR_S3_BUCKET}

DATE=$(date +"%Y-%m")
MIRROR_PATH=/tmp/$BUILDKITE_PIPELINE_SLUG.git
ZIP_PATH=/tmp/$DATE.git.zip

# Ensure the destination is empty
rm -rf "$MIRROR_PATH"

# We need to trust the remote keys in order to clone via SSH
add_host_to_ssh_known_hosts github.com
add_host_to_ssh_known_hosts bitbucket.com

# Download the repo
git clone --mirror "$BUILDKITE_REPO" "$MIRROR_PATH"

# Zip the Git Mirror using zero compression â€“ Git is pretty efficient space-wise, instead we
# are trying to make the mirror easier to move around as a unit without spending a lot of time
# compressing and decompressing.
pushd /tmp
zip -r -0 "$ZIP_PATH" ${BUILDKITE_PIPELINE_SLUG}.git
popd

# Copy the file to S3
aws s3 cp "$ZIP_PATH" "s3://${AWS_BUCKET}/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}/${DATE}.git.zip"

# Clean up after ourselves
rm -rf ${MIRROR_PATH} ${ZIP_PATH}
