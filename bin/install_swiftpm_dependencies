#!/bin/bash -eu

WORKSPACE_PACKAGE_RESOLVED_PATH=*.xcworkspace/xcshareddata/swiftpm/Package.resolved
ROOT_PACKAGE_RESOLVED_PATH=Package.resolved

# Find where Package.resolved is located
if  [ -f $WORKSPACE_PACKAGE_RESOLVED_PATH ]; then
	PACKAGE_RESOLVED_LOCATION=$WORKSPACE_PACKAGE_RESOLVED_PATH
elif  [ -f $ROOT_PACKAGE_RESOLVED_PATH ]; then
	PACKAGE_RESOLVED_LOCATION=$ROOT_PACKAGE_RESOLVED_PATH
else
	echo "Unable to find Package.resolved"
fi

PACKAGE_RESOLVED_HASH=$(hash_file "$PACKAGE_RESOLVED_LOCATION")
CACHEKEY="$BUILDKITE_PIPELINE_SLUG-spm-cache-$PACKAGE_RESOLVED_HASH"

# Restore SPM cache if it's available
mkdir -p vendor/spm
cd vendor/spm
restore_cache "$CACHEKEY"


sudo defaults write com.apple.dt.Xcode IDEPackageSupportUseBuiltinSCM YES

# Trust all GitHub.com and BitBucket.org keys â€“ this allows checking out dependencies via SSH
add_host_to_ssh_known_hosts bitbucket.org
add_host_to_ssh_known_hosts github.com

xcodebuild -resolvePackageDependencies


# If this is the first time we've seen this particular cache key, save it for the future
save_cache vendor/spm "$CACHEKEY"
