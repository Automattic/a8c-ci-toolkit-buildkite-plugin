#!/bin/bash -eu

# This script is used to comment on a pull request, and must be run in a buldkite PR step.
#
# It takes two arguments:
# 1. The comment to post, or the path to a file containing the comment
# 2. The GitHub token to use to post the comment

# Check dependencies and print their versions for diagnosis purposes
cat <<EOF
> jq --version
$(jq --version)

> curl --version
$(curl --version)

EOF

if [[ "${BUILDKITE_PULL_REQUEST:-invalid}" == "invalid" ]]; then
    echo "Error: this tool can only be called from a Buildkite PR job"
    exit 1
fi

if [[ -f "$1" ]]; then
    PR_COMMENT=$(cat "$1")
else
    PR_COMMENT="$1"
fi

GITHUB_TOKEN=$2

GITHUB_URL="${BUILDKITE_PULL_REQUEST_REPO%.git}"
GITHUB_USER=$(basename "$(dirname "$GITHUB_URL")")
GITHUB_REPO=$(basename "$GITHUB_URL")

JSON_PAYLOAD=$(jq --null-input --arg body "$PR_COMMENT" '{body: $body}')

curl -s -X POST \
    --fail-with-body \
    -H "Authorization: token ${GITHUB_TOKEN}" \
    -H "Content-Type: application/json" \
    -H "Accept: application/vnd.github+json" \
    -d "${JSON_PAYLOAD}" \
    "https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/issues/${BUILDKITE_PULL_REQUEST}/comments"
